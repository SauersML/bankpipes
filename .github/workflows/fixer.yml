name: Fix

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  fix-non-breaking-spaces:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Check for non-breaking spaces and fix them
      id: fix-nbsp
      run: |
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        if [[ "$COMMIT_MSG" == *"[bot] Auto-fix non-breaking spaces"* ]]; then
          echo "changes_made=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        changes_made=false
        files_changed=""
        temp_results=$(mktemp)
        
        find . -type f -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./.venv/*" -not -path "./venv/*" -not -path "./__pycache__/*" -not -path "*/.*cache*/*" -not -path "./build/*" -not -path "./dist/*" -not -path "./.next/*" -not -path "./target/*" -not -path "./.github/*" -not -name "*.png" -not -name "*.jpg" -not -name "*.jpeg" -not -name "*.gif" -not -name "*.pdf" -not -name "*.ico" -not -name "*.woff*" -not -name "*.ttf" -not -name "*.eot" -not -name "*.zip" -not -name "*.tar.gz" -not -name "*.exe" -not -name "*.dll" -not -name "*.so" -not -name "*.dylib" -not -name "*.bin" -not -name "*.class" -exec sh -c 'for file; do if file "$file" 2>/dev/null | grep -qi "binary\|executable\|archive"; then continue; fi; if hexdump -C "$file" 2>/dev/null | grep -q "c2 a0"; then cp "$file" "$file.backup"; sed -i "s/$(printf '\''\xc2\xa0'\'')/ /g" "$file" 2>/dev/null; if ! hexdump -C "$file" 2>/dev/null | grep -q "c2 a0"; then echo "$file" >> '"$temp_results"'; rm -f "$file.backup"; else mv "$file.backup" "$file"; fi; fi; done' sh {} +
        
        if [ -s "$temp_results" ]; then
          changes_made=true
          files_changed=$(cat "$temp_results" | tr '\n' ' ' | sed 's/ $//')
          echo "changes_made=true" >> $GITHUB_OUTPUT
          echo "files_changed=$files_changed" >> $GITHUB_OUTPUT
        else
          echo "changes_made=false" >> $GITHUB_OUTPUT
        fi
        
        rm -f "$temp_results"

    - name: Configure Git
      if: steps.fix-nbsp.outputs.changes_made == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"

    - name: Commit and push changes
      if: steps.fix-nbsp.outputs.changes_made == 'true'
      run: |
        git add -A
        git commit -m "[bot] Auto-fix non-breaking spaces - Files: ${{ steps.fix-nbsp.outputs.files_changed }} [skip ci]"
        git push

    - name: Create comment on PR
      if: steps.fix-nbsp.outputs.changes_made == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const files = '${{ steps.fix-nbsp.outputs.files_changed }}';
          const fileList = files.split(' ').filter(f => f.length > 0).map(f => `\`${f}\``).join(', ');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸ¤– Auto-fixed non-breaking spaces in: ${fileList}`
          });

    - name: Summary
      run: |
        if [ "${{ steps.fix-nbsp.outputs.changes_made }}" = "true" ]; then
          echo "âœ… Fixed files: ${{ steps.fix-nbsp.outputs.files_changed }}"
        else
          echo "âœ… No non-breaking spaces found"
        fi
